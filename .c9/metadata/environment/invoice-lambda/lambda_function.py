{"filter":false,"title":"lambda_function.py","tooltip":"/invoice-lambda/lambda_function.py","undoManager":{"mark":18,"position":18,"stack":[[{"start":{"row":0,"column":0},"end":{"row":0,"column":18},"action":"insert","lines":["lambda_function.py"],"id":16}],[{"start":{"row":0,"column":0},"end":{"row":0,"column":18},"action":"remove","lines":["lambda_function.py"],"id":17}],[{"start":{"row":0,"column":0},"end":{"row":124,"column":0},"action":"insert","lines":["import json","import boto3","import os","import smtplib","from reportlab.lib.pagesizes import A4","from reportlab.pdfgen import canvas","from email.mime.application import MIMEApplication","from email.mime.multipart import MIMEMultipart","from email.mime.text import MIMEText","from io import BytesIO","from datetime import datetime","","# Load environment variables","s3_bucket = os.environ.get(\"BILL_BUCKET\", \"s3-cpp-x23300841\")","SMTP_HOST = os.environ.get(\"SMTP_SERVER\", \"smtp.gmail.com\")","SMTP_PORT = int(os.environ.get(\"SMTP_PORT\", \"587\"))","SMTP_USER = os.environ.get(\"SMTP_USER\")","SMTP_PASS = os.environ.get(\"SMTP_PASSWORD\")","","","def generate_pdf(order_id, name, email, products, total):","    buffer = BytesIO()","    c = canvas.Canvas(buffer, pagesize=A4)","","    c.setFont(\"Helvetica-Bold\", 16)","    c.drawString(50, 800, f\"Order Invoice #{order_id}\")","","    c.setFont(\"Helvetica\", 12)","    c.drawString(50, 770, f\"Customer Name: {name}\")","    c.drawString(50, 750, f\"Customer Email: {email}\")","    c.drawString(50, 730, f\"Date: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')}\")","","    y = 700","    c.setFont(\"Helvetica-Bold\", 12)","    c.drawString(50, y, \"Products:\")","    y -= 20","","    c.setFont(\"Helvetica\", 11)","    for item in products:","        c.drawString(50, y, f\"{item['name']}  x{item['qty']}  ${item['price']}\")","        y -= 20","","    c.setFont(\"Helvetica-Bold\", 12)","    c.drawString(50, y - 10, f\"Total Amount: ${total}\")","","    c.showPage()","    c.save()","","    buffer.seek(0)","    return buffer.getvalue()","","","def upload_to_s3(pdf_bytes, pdf_filename):","    s3 = boto3.client(\"s3\")","    s3.put_object(","        Bucket=s3_bucket,","        Key=pdf_filename,","        Body=pdf_bytes,","        ContentType=\"application/pdf\"","    )","    return f\"s3://{s3_bucket}/{pdf_filename}\"","","","def send_email_smtp(to_email, subject, body, pdf_bytes, filename):","    msg = MIMEMultipart()","    msg[\"Subject\"] = subject","    msg[\"From\"] = SMTP_USER","    msg[\"To\"] = to_email","","    msg.attach(MIMEText(body, \"plain\"))","","    # Attach PDF","    part = MIMEApplication(pdf_bytes, Name=filename)","    part['Content-Disposition'] = f'attachment; filename=\"{filename}\"'","    msg.attach(part)","","    # Send via SMTP","    with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as smtp:","        smtp.starttls()","        smtp.login(SMTP_USER, SMTP_PASS)","        smtp.sendmail(SMTP_USER, to_email, msg.as_string())","","","def lambda_handler(event, context):","    try:","        body = json.loads(event.get(\"body\", \"{}\"))","","        order_id = body[\"order_id\"]","        name = body[\"name\"]","        email = body[\"email\"]","        products = body[\"products\"]   # [{'name': 'Laptop', 'qty': 1, 'price': 750}]","        total = body[\"total\"]","","        # Generate PDF","        pdf_data = generate_pdf(order_id, name, email, products, total)","        pdf_filename = f\"invoice_{order_id}.pdf\"","","        # Upload to S3","        s3_path = upload_to_s3(pdf_data, pdf_filename)","","        # Email the PDF","        send_email_smtp(","            to_email=email,","            subject=f\"Your Invoice - Order #{order_id}\",","            body=\"Thank you for shopping with us! Your invoice is attached.\",","            pdf_bytes=pdf_data,","            filename=pdf_filename","        )","","        return {","            \"statusCode\": 200,","            \"body\": json.dumps({","                \"status\": \"success\",","                \"message\": \"Invoice generated and emailed successfully\",","                \"file\": s3_path","            })","        }","","    except Exception as e:","        print(\"ERROR:\", e)","        return {","            \"statusCode\": 500,","            \"body\": json.dumps({\"status\": \"error\", \"message\": str(e)})","        }",""],"id":18}],[{"start":{"row":16,"column":28},"end":{"row":16,"column":37},"action":"remove","lines":["SMTP_USER"],"id":19}],[{"start":{"row":17,"column":28},"end":{"row":17,"column":41},"action":"remove","lines":["SMTP_PASSWORD"],"id":20}],[{"start":{"row":16,"column":28},"end":{"row":16,"column":53},"action":"insert","lines":["projectmail2223@gmail.com"],"id":21}],[{"start":{"row":17,"column":28},"end":{"row":17,"column":47},"action":"insert","lines":["gkqh wycs chvb zdfg"],"id":22}],[{"start":{"row":17,"column":43},"end":{"row":17,"column":47},"action":"remove","lines":["zdfg"],"id":23}],[{"start":{"row":17,"column":42},"end":{"row":17,"column":43},"action":"remove","lines":[" "],"id":24}],[{"start":{"row":17,"column":38},"end":{"row":17,"column":42},"action":"remove","lines":["chvb"],"id":25}],[{"start":{"row":17,"column":37},"end":{"row":17,"column":38},"action":"remove","lines":[" "],"id":26}],[{"start":{"row":17,"column":33},"end":{"row":17,"column":37},"action":"remove","lines":["wycs"],"id":27}],[{"start":{"row":17,"column":32},"end":{"row":17,"column":33},"action":"remove","lines":[" "],"id":28}],[{"start":{"row":17,"column":28},"end":{"row":17,"column":32},"action":"remove","lines":["gkqh"],"id":29}],[{"start":{"row":17,"column":28},"end":{"row":17,"column":47},"action":"insert","lines":["edgr mtfg slve gjnr"],"id":30}],[{"start":{"row":17,"column":28},"end":{"row":17,"column":47},"action":"remove","lines":["edgr mtfg slve gjnr"],"id":31},{"start":{"row":17,"column":28},"end":{"row":17,"column":47},"action":"insert","lines":["qkhc idzh thts lqkj"]}],[{"start":{"row":16,"column":0},"end":{"row":16,"column":2},"action":"insert","lines":["# "],"id":33},{"start":{"row":17,"column":0},"end":{"row":17,"column":2},"action":"insert","lines":["# "]}],[{"start":{"row":17,"column":51},"end":{"row":18,"column":0},"action":"insert","lines":["",""],"id":34},{"start":{"row":18,"column":0},"end":{"row":19,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":19,"column":0},"end":{"row":21,"column":0},"action":"insert","lines":["SMTP_USER = os.environ.get(\"SMTP_USER\")","SMTP_PASS = os.environ.get(\"SMTP_PASS\")",""],"id":35}]]},"ace":{"folds":[],"scrolltop":33,"scrollleft":0,"selection":{"start":{"row":12,"column":28},"end":{"row":12,"column":28},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":132,"mode":"ace/mode/python"}},"timestamp":1763788926834,"hash":"dea4c1459dc22e801f368ca2f4dac2f9cd3c562e"}